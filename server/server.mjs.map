{"version":3,"sources":["node_modules/@softarc/native-federation-node/src/lib/utils/import-map-loader.js","node_modules/@softarc/native-federation-node/src/lib/utils/loader-as-data-url.js","node_modules/@softarc/native-federation-node/src/lib/node/init-node-federation.js","node_modules/@softarc/native-federation-node/src/index.js","projects/spear/server.ts"],"sourcesContent":["import path from 'path';\nimport url from 'url';\nimport { promises as fs } from 'fs';\nexport const IMPORT_MAP_FILE_NAME = 'node.importmap';\nconst baseURL = url.pathToFileURL(process.cwd()) + path.sep;\n// https://wicg.github.io/import-maps/#new-resolve-algorithm\nexport function resolveSpecifier(importMap, specifier, parentURL) {\n    let currentBaseURL;\n    if (parentURL) {\n        const lastSlashIndex = parentURL.lastIndexOf(path.sep);\n        currentBaseURL = parentURL.slice(0, lastSlashIndex + 1);\n    }\n    else {\n        currentBaseURL = baseURL;\n    }\n    const normalizedSpecifier = parseURLLikeSpecifier(specifier, currentBaseURL) || specifier;\n    for (let scopePrefix in importMap.scopes) {\n        if (scopePrefix === currentBaseURL ||\n            (scopePrefix.endsWith('/') && currentBaseURL.startsWith(scopePrefix))) {\n            const scopeImportsMatch = resolveImportsMatch(normalizedSpecifier, importMap.scopes[scopePrefix]);\n            if (scopeImportsMatch) {\n                return scopeImportsMatch;\n            }\n        }\n        else {\n            const topLevelImportsMatch = resolveImportsMatch(normalizedSpecifier, importMap.imports);\n            if (topLevelImportsMatch) {\n                return topLevelImportsMatch;\n            }\n        }\n    }\n    return resolveImportsMatch(normalizedSpecifier, importMap.imports);\n}\n// https://wicg.github.io/import-maps/#resolve-an-imports-match\nfunction resolveImportsMatch(normalizedSpecifier, specifierMap) {\n    for (let specifierKey in specifierMap) {\n        const resolutionResult = specifierMap[specifierKey];\n        if (specifierKey === normalizedSpecifier) {\n            if (resolutionResult === null) {\n                throw TypeError(`The import map resolution of ${specifierKey} failed due to a null entry`);\n            }\n            return resolutionResult;\n        }\n        else if (specifierKey.endsWith('/') &&\n            normalizedSpecifier.startsWith(specifierKey)) {\n            if (resolutionResult === null) {\n                throw TypeError(`The import map resolution of ${specifierKey} failed due to a null entry`);\n            }\n            const afterPrefix = normalizedSpecifier.slice(specifierKey.length);\n            try {\n                return new URL(afterPrefix, resolutionResult).href;\n            }\n            catch {\n                throw TypeError(`The import map resolution of ${specifierKey} failed due to URL parse failure`);\n            }\n        }\n    }\n    return null;\n}\n// https://wicg.github.io/import-maps/#parsing\nexport function resolveAndComposeImportMap(parsed) {\n    // Step 2\n    if (!isPlainObject(parsed)) {\n        throw Error(`Invalid import map - top level must be an object`);\n    }\n    // Step 3\n    let sortedAndNormalizedImports = {};\n    // Step 4\n    if (parsed.hasOwnProperty('imports')) {\n        // Step 4.1\n        if (!isPlainObject(parsed.imports)) {\n            throw Error(`Invalid import map - \"imports\" property must be an object`);\n        }\n        // Step 4.2\n        sortedAndNormalizedImports = sortAndNormalizeSpecifierMap(parsed.imports, baseURL);\n    }\n    // Step 5\n    let sortedAndNormalizedScopes = {};\n    // Step 6\n    if (parsed.hasOwnProperty('scopes')) {\n        // Step 6.1\n        if (!isPlainObject(parsed.scopes)) {\n            throw Error(`Invalid import map - \"scopes\" property must be an object`);\n        }\n        // Step 6.2\n        sortedAndNormalizedScopes = sortAndNormalizeScopes(parsed.scopes, baseURL);\n    }\n    // Step 7\n    const invalidKeys = Object.keys(parsed).filter((key) => key !== 'imports' && key !== 'scopes');\n    if (invalidKeys.length > 0) {\n        console.warn(`Invalid top-level key${invalidKeys.length > 0 ? 's' : ''} in import map - ${invalidKeys.join(', ')}`);\n    }\n    // Step 8\n    return {\n        imports: sortedAndNormalizedImports,\n        scopes: sortedAndNormalizedScopes,\n    };\n}\n// https://wicg.github.io/import-maps/#sort-and-normalize-a-specifier-map\nfunction sortAndNormalizeSpecifierMap(map, baseURL) {\n    const normalized = {};\n    for (let specifierKey in map) {\n        const value = map[specifierKey];\n        const normalizedSpecifierKey = normalizeSpecifierKey(specifierKey, baseURL);\n        if (normalizedSpecifierKey === null) {\n            continue;\n        }\n        let addressURL = parseURLLikeSpecifier(value, baseURL);\n        if (addressURL === null) {\n            console.warn(`Invalid URL address for import map specifier '${specifierKey}'`);\n            normalized[normalizedSpecifierKey] = null;\n            continue;\n        }\n        if (specifierKey.endsWith('/') && !addressURL.endsWith('/')) {\n            console.warn(`Invalid URL address for import map specifier '${specifierKey}' - since the specifier ends in slash, so must the address`);\n            normalized[normalizedSpecifierKey] = null;\n            continue;\n        }\n        normalized[normalizedSpecifierKey] = addressURL;\n    }\n    return normalized;\n}\n// https://wicg.github.io/import-maps/#normalize-a-specifier-key\nfunction normalizeSpecifierKey(key) {\n    if (key === '') {\n        console.warn(`Specifier keys in import maps may not be the empty string`);\n        return null;\n    }\n    return parseURLLikeSpecifier(key, baseURL) || key;\n}\n// https://wicg.github.io/import-maps/#parse-a-url-like-import-specifier\nfunction parseURLLikeSpecifier(specifier, baseURL) {\n    const useBaseUrlAsParent = specifier.startsWith('/') ||\n        specifier.startsWith('./') ||\n        specifier.startsWith('../');\n    try {\n        return new URL(specifier, useBaseUrlAsParent ? baseURL : undefined).href;\n    }\n    catch {\n        return null;\n    }\n}\n// https://wicg.github.io/import-maps/#sort-and-normalize-scopes\nfunction sortAndNormalizeScopes(map, baseURL) {\n    let normalized = {};\n    for (let scopePrefix in map) {\n        const potentialSpecifierMap = map[scopePrefix];\n        if (!isPlainObject(potentialSpecifierMap)) {\n            throw TypeError(`The value of scope ${scopePrefix} must be a JSON object`);\n        }\n        let scopePrefixURL;\n        try {\n            scopePrefixURL = new URL(scopePrefix, baseURL).href;\n        }\n        catch {\n            console.warn(`Scope prefix URL '${scopePrefix}' was not parseable in import map`);\n            continue;\n        }\n        normalized[scopePrefixURL] = sortAndNormalizeSpecifierMap(potentialSpecifierMap, baseURL);\n    }\n    return normalized;\n}\nfunction isPlainObject(obj) {\n    return obj === Object(obj) && !Array.isArray(obj);\n}\n// ---\nlet importMapPromise = getImportMapPromise();\nexport async function resolve(specifier, context, defaultResolve) {\n    const { parentURL = null } = context;\n    const importMap = await importMapPromise;\n    const importMapUrl = resolveSpecifier(importMap, specifier, parentURL);\n    return defaultResolve(importMapUrl ?? specifier, context, defaultResolve);\n}\nexport async function load(url, context, defaultLoad) {\n    if (url.startsWith('http://') || url.startsWith('https://')) {\n        const res = await fetch(url);\n        if (!res.ok) {\n            throw new Error(`Failed to fetch module from ${url}`);\n        }\n        const source = await res.text();\n        return {\n            shortCircuit: true,\n            format: 'module',\n            source,\n        };\n    }\n    if (!url.startsWith('node:')) {\n        context.format = 'module';\n    }\n    return defaultLoad(url, context, defaultLoad);\n}\nasync function getImportMapPromise() {\n    const relativePath = process.env.IMPORT_MAP_PATH || IMPORT_MAP_FILE_NAME;\n    const importMapPath = path.resolve(process.cwd(), relativePath);\n    let str;\n    try {\n        str = await fs.readFile(importMapPath);\n    }\n    catch (err) {\n        return emptyMap();\n    }\n    let json;\n    try {\n        json = await JSON.parse(str);\n    }\n    catch (err) {\n        throw Error(`Import map at ${importMapPath} contains invalid json: ${err.message}`);\n    }\n    return resolveAndComposeImportMap(json);\n}\nglobal.nodeLoader = global.nodeLoader || {};\nglobal.nodeLoader.setImportMapPromise = function setImportMapPromise(promise) {\n    importMapPromise = promise.then((map) => {\n        return resolveAndComposeImportMap(map);\n    });\n};\nfunction emptyMap() {\n    return { imports: {}, scopes: {} };\n}\n","export const resolver = \"aW1wb3J0IHBhdGggZnJvbSAncGF0aCc7CmltcG9ydCB1cmwgZnJvbSAndXJsJzsKaW1wb3J0IHsgcHJvbWlzZXMgYXMgZnMgfSBmcm9tICdmcyc7CgpleHBvcnQgY29uc3QgSU1QT1JUX01BUF9GSUxFX05BTUUgPSAnbm9kZS5pbXBvcnRtYXAnOwoKY29uc3QgYmFzZVVSTCA9IHVybC5wYXRoVG9GaWxlVVJMKHByb2Nlc3MuY3dkKCkpICsgcGF0aC5zZXA7CgovLyBodHRwczovL3dpY2cuZ2l0aHViLmlvL2ltcG9ydC1tYXBzLyNuZXctcmVzb2x2ZS1hbGdvcml0aG0KZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVTcGVjaWZpZXIoaW1wb3J0TWFwLCBzcGVjaWZpZXIsIHBhcmVudFVSTCkgewogIGxldCBjdXJyZW50QmFzZVVSTDsKICBpZiAocGFyZW50VVJMKSB7CiAgICBjb25zdCBsYXN0U2xhc2hJbmRleCA9IHBhcmVudFVSTC5sYXN0SW5kZXhPZihwYXRoLnNlcCk7CiAgICBjdXJyZW50QmFzZVVSTCA9IHBhcmVudFVSTC5zbGljZSgwLCBsYXN0U2xhc2hJbmRleCArIDEpOwogIH0gZWxzZSB7CiAgICBjdXJyZW50QmFzZVVSTCA9IGJhc2VVUkw7CiAgfQogIGNvbnN0IG5vcm1hbGl6ZWRTcGVjaWZpZXIgPQogICAgcGFyc2VVUkxMaWtlU3BlY2lmaWVyKHNwZWNpZmllciwgY3VycmVudEJhc2VVUkwpIHx8IHNwZWNpZmllcjsKICBmb3IgKGxldCBzY29wZVByZWZpeCBpbiBpbXBvcnRNYXAuc2NvcGVzKSB7CiAgICBpZiAoCiAgICAgIHNjb3BlUHJlZml4ID09PSBjdXJyZW50QmFzZVVSTCB8fAogICAgICAoc2NvcGVQcmVmaXguZW5kc1dpdGgoJy8nKSAmJiBjdXJyZW50QmFzZVVSTC5zdGFydHNXaXRoKHNjb3BlUHJlZml4KSkKICAgICkgewogICAgICBjb25zdCBzY29wZUltcG9ydHNNYXRjaCA9IHJlc29sdmVJbXBvcnRzTWF0Y2goCiAgICAgICAgbm9ybWFsaXplZFNwZWNpZmllciwKICAgICAgICBpbXBvcnRNYXAuc2NvcGVzW3Njb3BlUHJlZml4XQogICAgICApOwogICAgICBpZiAoc2NvcGVJbXBvcnRzTWF0Y2gpIHsKICAgICAgICByZXR1cm4gc2NvcGVJbXBvcnRzTWF0Y2g7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHRvcExldmVsSW1wb3J0c01hdGNoID0gcmVzb2x2ZUltcG9ydHNNYXRjaCgKICAgICAgICBub3JtYWxpemVkU3BlY2lmaWVyLAogICAgICAgIGltcG9ydE1hcC5pbXBvcnRzCiAgICAgICk7CiAgICAgIGlmICh0b3BMZXZlbEltcG9ydHNNYXRjaCkgewogICAgICAgIHJldHVybiB0b3BMZXZlbEltcG9ydHNNYXRjaDsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHJlc29sdmVJbXBvcnRzTWF0Y2gobm9ybWFsaXplZFNwZWNpZmllciwgaW1wb3J0TWFwLmltcG9ydHMpOwp9CgovLyBodHRwczovL3dpY2cuZ2l0aHViLmlvL2ltcG9ydC1tYXBzLyNyZXNvbHZlLWFuLWltcG9ydHMtbWF0Y2gKZnVuY3Rpb24gcmVzb2x2ZUltcG9ydHNNYXRjaChub3JtYWxpemVkU3BlY2lmaWVyLCBzcGVjaWZpZXJNYXApIHsKICBmb3IgKGxldCBzcGVjaWZpZXJLZXkgaW4gc3BlY2lmaWVyTWFwKSB7CiAgICBjb25zdCByZXNvbHV0aW9uUmVzdWx0ID0gc3BlY2lmaWVyTWFwW3NwZWNpZmllcktleV07CgogICAgaWYgKHNwZWNpZmllcktleSA9PT0gbm9ybWFsaXplZFNwZWNpZmllcikgewogICAgICBpZiAocmVzb2x1dGlvblJlc3VsdCA9PT0gbnVsbCkgewogICAgICAgIHRocm93IFR5cGVFcnJvcigKICAgICAgICAgIGBUaGUgaW1wb3J0IG1hcCByZXNvbHV0aW9uIG9mICR7c3BlY2lmaWVyS2V5fSBmYWlsZWQgZHVlIHRvIGEgbnVsbCBlbnRyeWAKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiByZXNvbHV0aW9uUmVzdWx0OwogICAgfSBlbHNlIGlmICgKICAgICAgc3BlY2lmaWVyS2V5LmVuZHNXaXRoKCcvJykgJiYKICAgICAgbm9ybWFsaXplZFNwZWNpZmllci5zdGFydHNXaXRoKHNwZWNpZmllcktleSkKICAgICkgewogICAgICBpZiAocmVzb2x1dGlvblJlc3VsdCA9PT0gbnVsbCkgewogICAgICAgIHRocm93IFR5cGVFcnJvcigKICAgICAgICAgIGBUaGUgaW1wb3J0IG1hcCByZXNvbHV0aW9uIG9mICR7c3BlY2lmaWVyS2V5fSBmYWlsZWQgZHVlIHRvIGEgbnVsbCBlbnRyeWAKICAgICAgICApOwogICAgICB9CiAgICAgIGNvbnN0IGFmdGVyUHJlZml4ID0gbm9ybWFsaXplZFNwZWNpZmllci5zbGljZShzcGVjaWZpZXJLZXkubGVuZ3RoKTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gbmV3IFVSTChhZnRlclByZWZpeCwgcmVzb2x1dGlvblJlc3VsdCkuaHJlZjsKICAgICAgfSBjYXRjaCB7CiAgICAgICAgdGhyb3cgVHlwZUVycm9yKAogICAgICAgICAgYFRoZSBpbXBvcnQgbWFwIHJlc29sdXRpb24gb2YgJHtzcGVjaWZpZXJLZXl9IGZhaWxlZCBkdWUgdG8gVVJMIHBhcnNlIGZhaWx1cmVgCiAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIG51bGw7Cn0KCi8vIGh0dHBzOi8vd2ljZy5naXRodWIuaW8vaW1wb3J0LW1hcHMvI3BhcnNpbmcKZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVBbmRDb21wb3NlSW1wb3J0TWFwKHBhcnNlZCkgewogIC8vIFN0ZXAgMgogIGlmICghaXNQbGFpbk9iamVjdChwYXJzZWQpKSB7CiAgICB0aHJvdyBFcnJvcihgSW52YWxpZCBpbXBvcnQgbWFwIC0gdG9wIGxldmVsIG11c3QgYmUgYW4gb2JqZWN0YCk7CiAgfQoKICAvLyBTdGVwIDMKICBsZXQgc29ydGVkQW5kTm9ybWFsaXplZEltcG9ydHMgPSB7fTsKCiAgLy8gU3RlcCA0CiAgaWYgKHBhcnNlZC5oYXNPd25Qcm9wZXJ0eSgnaW1wb3J0cycpKSB7CiAgICAvLyBTdGVwIDQuMQogICAgaWYgKCFpc1BsYWluT2JqZWN0KHBhcnNlZC5pbXBvcnRzKSkgewogICAgICB0aHJvdyBFcnJvcihgSW52YWxpZCBpbXBvcnQgbWFwIC0gImltcG9ydHMiIHByb3BlcnR5IG11c3QgYmUgYW4gb2JqZWN0YCk7CiAgICB9CgogICAgLy8gU3RlcCA0LjIKICAgIHNvcnRlZEFuZE5vcm1hbGl6ZWRJbXBvcnRzID0gc29ydEFuZE5vcm1hbGl6ZVNwZWNpZmllck1hcCgKICAgICAgcGFyc2VkLmltcG9ydHMsCiAgICAgIGJhc2VVUkwKICAgICk7CiAgfQoKICAvLyBTdGVwIDUKICBsZXQgc29ydGVkQW5kTm9ybWFsaXplZFNjb3BlcyA9IHt9OwoKICAvLyBTdGVwIDYKICBpZiAocGFyc2VkLmhhc093blByb3BlcnR5KCdzY29wZXMnKSkgewogICAgLy8gU3RlcCA2LjEKICAgIGlmICghaXNQbGFpbk9iamVjdChwYXJzZWQuc2NvcGVzKSkgewogICAgICB0aHJvdyBFcnJvcihgSW52YWxpZCBpbXBvcnQgbWFwIC0gInNjb3BlcyIgcHJvcGVydHkgbXVzdCBiZSBhbiBvYmplY3RgKTsKICAgIH0KCiAgICAvLyBTdGVwIDYuMgogICAgc29ydGVkQW5kTm9ybWFsaXplZFNjb3BlcyA9IHNvcnRBbmROb3JtYWxpemVTY29wZXMocGFyc2VkLnNjb3BlcywgYmFzZVVSTCk7CiAgfQoKICAvLyBTdGVwIDcKICBjb25zdCBpbnZhbGlkS2V5cyA9IE9iamVjdC5rZXlzKHBhcnNlZCkuZmlsdGVyKAogICAgKGtleSkgPT4ga2V5ICE9PSAnaW1wb3J0cycgJiYga2V5ICE9PSAnc2NvcGVzJwogICk7CiAgaWYgKGludmFsaWRLZXlzLmxlbmd0aCA+IDApIHsKICAgIGNvbnNvbGUud2FybigKICAgICAgYEludmFsaWQgdG9wLWxldmVsIGtleSR7CiAgICAgICAgaW52YWxpZEtleXMubGVuZ3RoID4gMCA/ICdzJyA6ICcnCiAgICAgIH0gaW4gaW1wb3J0IG1hcCAtICR7aW52YWxpZEtleXMuam9pbignLCAnKX1gCiAgICApOwogIH0KCiAgLy8gU3RlcCA4CiAgcmV0dXJuIHsKICAgIGltcG9ydHM6IHNvcnRlZEFuZE5vcm1hbGl6ZWRJbXBvcnRzLAogICAgc2NvcGVzOiBzb3J0ZWRBbmROb3JtYWxpemVkU2NvcGVzLAogIH07Cn0KCi8vIGh0dHBzOi8vd2ljZy5naXRodWIuaW8vaW1wb3J0LW1hcHMvI3NvcnQtYW5kLW5vcm1hbGl6ZS1hLXNwZWNpZmllci1tYXAKZnVuY3Rpb24gc29ydEFuZE5vcm1hbGl6ZVNwZWNpZmllck1hcChtYXAsIGJhc2VVUkwpIHsKICBjb25zdCBub3JtYWxpemVkID0ge307CgogIGZvciAobGV0IHNwZWNpZmllcktleSBpbiBtYXApIHsKICAgIGNvbnN0IHZhbHVlID0gbWFwW3NwZWNpZmllcktleV07CgogICAgY29uc3Qgbm9ybWFsaXplZFNwZWNpZmllcktleSA9IG5vcm1hbGl6ZVNwZWNpZmllcktleShzcGVjaWZpZXJLZXksIGJhc2VVUkwpOwogICAgaWYgKG5vcm1hbGl6ZWRTcGVjaWZpZXJLZXkgPT09IG51bGwpIHsKICAgICAgY29udGludWU7CiAgICB9CgogICAgbGV0IGFkZHJlc3NVUkwgPSBwYXJzZVVSTExpa2VTcGVjaWZpZXIodmFsdWUsIGJhc2VVUkwpOwogICAgaWYgKGFkZHJlc3NVUkwgPT09IG51bGwpIHsKICAgICAgY29uc29sZS53YXJuKAogICAgICAgIGBJbnZhbGlkIFVSTCBhZGRyZXNzIGZvciBpbXBvcnQgbWFwIHNwZWNpZmllciAnJHtzcGVjaWZpZXJLZXl9J2AKICAgICAgKTsKICAgICAgbm9ybWFsaXplZFtub3JtYWxpemVkU3BlY2lmaWVyS2V5XSA9IG51bGw7CiAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIGlmIChzcGVjaWZpZXJLZXkuZW5kc1dpdGgoJy8nKSAmJiAhYWRkcmVzc1VSTC5lbmRzV2l0aCgnLycpKSB7CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICBgSW52YWxpZCBVUkwgYWRkcmVzcyBmb3IgaW1wb3J0IG1hcCBzcGVjaWZpZXIgJyR7c3BlY2lmaWVyS2V5fScgLSBzaW5jZSB0aGUgc3BlY2lmaWVyIGVuZHMgaW4gc2xhc2gsIHNvIG11c3QgdGhlIGFkZHJlc3NgCiAgICAgICk7CiAgICAgIG5vcm1hbGl6ZWRbbm9ybWFsaXplZFNwZWNpZmllcktleV0gPSBudWxsOwogICAgICBjb250aW51ZTsKICAgIH0KCiAgICBub3JtYWxpemVkW25vcm1hbGl6ZWRTcGVjaWZpZXJLZXldID0gYWRkcmVzc1VSTDsKICB9CgogIHJldHVybiBub3JtYWxpemVkOwp9CgovLyBodHRwczovL3dpY2cuZ2l0aHViLmlvL2ltcG9ydC1tYXBzLyNub3JtYWxpemUtYS1zcGVjaWZpZXIta2V5CmZ1bmN0aW9uIG5vcm1hbGl6ZVNwZWNpZmllcktleShrZXkpIHsKICBpZiAoa2V5ID09PSAnJykgewogICAgY29uc29sZS53YXJuKGBTcGVjaWZpZXIga2V5cyBpbiBpbXBvcnQgbWFwcyBtYXkgbm90IGJlIHRoZSBlbXB0eSBzdHJpbmdgKTsKICAgIHJldHVybiBudWxsOwogIH0KCiAgcmV0dXJuIHBhcnNlVVJMTGlrZVNwZWNpZmllcihrZXksIGJhc2VVUkwpIHx8IGtleTsKfQoKLy8gaHR0cHM6Ly93aWNnLmdpdGh1Yi5pby9pbXBvcnQtbWFwcy8jcGFyc2UtYS11cmwtbGlrZS1pbXBvcnQtc3BlY2lmaWVyCmZ1bmN0aW9uIHBhcnNlVVJMTGlrZVNwZWNpZmllcihzcGVjaWZpZXIsIGJhc2VVUkwpIHsKICBjb25zdCB1c2VCYXNlVXJsQXNQYXJlbnQgPQogICAgc3BlY2lmaWVyLnN0YXJ0c1dpdGgoJy8nKSB8fAogICAgc3BlY2lmaWVyLnN0YXJ0c1dpdGgoJy4vJykgfHwKICAgIHNwZWNpZmllci5zdGFydHNXaXRoKCcuLi8nKTsKCiAgdHJ5IHsKICAgIHJldHVybiBuZXcgVVJMKHNwZWNpZmllciwgdXNlQmFzZVVybEFzUGFyZW50ID8gYmFzZVVSTCA6IHVuZGVmaW5lZCkuaHJlZjsKICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsOwogIH0KfQoKLy8gaHR0cHM6Ly93aWNnLmdpdGh1Yi5pby9pbXBvcnQtbWFwcy8jc29ydC1hbmQtbm9ybWFsaXplLXNjb3BlcwpmdW5jdGlvbiBzb3J0QW5kTm9ybWFsaXplU2NvcGVzKG1hcCwgYmFzZVVSTCkgewogIGxldCBub3JtYWxpemVkID0ge307CgogIGZvciAobGV0IHNjb3BlUHJlZml4IGluIG1hcCkgewogICAgY29uc3QgcG90ZW50aWFsU3BlY2lmaWVyTWFwID0gbWFwW3Njb3BlUHJlZml4XTsKICAgIGlmICghaXNQbGFpbk9iamVjdChwb3RlbnRpYWxTcGVjaWZpZXJNYXApKSB7CiAgICAgIHRocm93IFR5cGVFcnJvcigKICAgICAgICBgVGhlIHZhbHVlIG9mIHNjb3BlICR7c2NvcGVQcmVmaXh9IG11c3QgYmUgYSBKU09OIG9iamVjdGAKICAgICAgKTsKICAgIH0KCiAgICBsZXQgc2NvcGVQcmVmaXhVUkw7CiAgICB0cnkgewogICAgICBzY29wZVByZWZpeFVSTCA9IG5ldyBVUkwoc2NvcGVQcmVmaXgsIGJhc2VVUkwpLmhyZWY7CiAgICB9IGNhdGNoIHsKICAgICAgY29uc29sZS53YXJuKAogICAgICAgIGBTY29wZSBwcmVmaXggVVJMICcke3Njb3BlUHJlZml4fScgd2FzIG5vdCBwYXJzZWFibGUgaW4gaW1wb3J0IG1hcGAKICAgICAgKTsKICAgICAgY29udGludWU7CiAgICB9CgogICAgbm9ybWFsaXplZFtzY29wZVByZWZpeFVSTF0gPSBzb3J0QW5kTm9ybWFsaXplU3BlY2lmaWVyTWFwKAogICAgICBwb3RlbnRpYWxTcGVjaWZpZXJNYXAsCiAgICAgIGJhc2VVUkwKICAgICk7CiAgfQoKICByZXR1cm4gbm9ybWFsaXplZDsKfQoKZnVuY3Rpb24gaXNQbGFpbk9iamVjdChvYmopIHsKICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKSAmJiAhQXJyYXkuaXNBcnJheShvYmopOwp9CgovLyAtLS0KCmxldCBpbXBvcnRNYXBQcm9taXNlID0gZ2V0SW1wb3J0TWFwUHJvbWlzZSgpOwoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlc29sdmUoc3BlY2lmaWVyLCBjb250ZXh0LCBkZWZhdWx0UmVzb2x2ZSkgewogIGNvbnN0IHsgcGFyZW50VVJMID0gbnVsbCB9ID0gY29udGV4dDsKICBjb25zdCBpbXBvcnRNYXAgPSBhd2FpdCBpbXBvcnRNYXBQcm9taXNlOwogIGNvbnN0IGltcG9ydE1hcFVybCA9IHJlc29sdmVTcGVjaWZpZXIoaW1wb3J0TWFwLCBzcGVjaWZpZXIsIHBhcmVudFVSTCk7CgogIHJldHVybiBkZWZhdWx0UmVzb2x2ZShpbXBvcnRNYXBVcmwgPz8gc3BlY2lmaWVyLCBjb250ZXh0LCBkZWZhdWx0UmVzb2x2ZSk7Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkKHVybCwgY29udGV4dCwgZGVmYXVsdExvYWQpIHsKICBpZiAodXJsLnN0YXJ0c1dpdGgoJ2h0dHA6Ly8nKSB8fCB1cmwuc3RhcnRzV2l0aCgnaHR0cHM6Ly8nKSkgewogICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsKTsKICAgIGlmICghcmVzLm9rKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGZldGNoIG1vZHVsZSBmcm9tICR7dXJsfWApOwogICAgfQogICAgY29uc3Qgc291cmNlID0gYXdhaXQgcmVzLnRleHQoKTsKICAgIHJldHVybiB7CiAgICAgIHNob3J0Q2lyY3VpdDogdHJ1ZSwKICAgICAgZm9ybWF0OiAnbW9kdWxlJywgCiAgICAgIHNvdXJjZSwKICAgIH07CiAgfQoKICBpZiAoIXVybC5zdGFydHNXaXRoKCdub2RlOicpKSB7CiAgICBjb250ZXh0LmZvcm1hdCA9ICdtb2R1bGUnOwogIH0KICAKICByZXR1cm4gZGVmYXVsdExvYWQodXJsLCBjb250ZXh0LCBkZWZhdWx0TG9hZCk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGdldEltcG9ydE1hcFByb21pc2UoKSB7CiAgY29uc3QgcmVsYXRpdmVQYXRoID0gcHJvY2Vzcy5lbnYuSU1QT1JUX01BUF9QQVRIIHx8IElNUE9SVF9NQVBfRklMRV9OQU1FOwogIGNvbnN0IGltcG9ydE1hcFBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgcmVsYXRpdmVQYXRoKTsKCiAgbGV0IHN0cjsKICB0cnkgewogICAgc3RyID0gYXdhaXQgZnMucmVhZEZpbGUoaW1wb3J0TWFwUGF0aCk7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gZW1wdHlNYXAoKTsKICB9CgogIGxldCBqc29uOwogIHRyeSB7CiAgICBqc29uID0gYXdhaXQgSlNPTi5wYXJzZShzdHIpOwogIH0gY2F0Y2ggKGVycikgewogICAgdGhyb3cgRXJyb3IoCiAgICAgIGBJbXBvcnQgbWFwIGF0ICR7aW1wb3J0TWFwUGF0aH0gY29udGFpbnMgaW52YWxpZCBqc29uOiAke2Vyci5tZXNzYWdlfWAKICAgICk7CiAgfQoKICByZXR1cm4gcmVzb2x2ZUFuZENvbXBvc2VJbXBvcnRNYXAoanNvbik7Cn0KCmdsb2JhbC5ub2RlTG9hZGVyID0gZ2xvYmFsLm5vZGVMb2FkZXIgfHwge307CgpnbG9iYWwubm9kZUxvYWRlci5zZXRJbXBvcnRNYXBQcm9taXNlID0gZnVuY3Rpb24gc2V0SW1wb3J0TWFwUHJvbWlzZShwcm9taXNlKSB7CiAgaW1wb3J0TWFwUHJvbWlzZSA9IHByb21pc2UudGhlbigobWFwKSA9PiB7CiAgICByZXR1cm4gcmVzb2x2ZUFuZENvbXBvc2VJbXBvcnRNYXAobWFwKTsKICB9KTsKfTsKCmZ1bmN0aW9uIGVtcHR5TWFwKCkgewogIHJldHVybiB7IGltcG9ydHM6IHt9LCBzY29wZXM6IHt9IH07Cn0K\";\n","import { register } from 'node:module';\nimport { pathToFileURL } from 'node:url';\nimport * as fs from 'node:fs/promises';\nimport * as path from 'node:path';\nimport { mergeImportMaps, processHostInfo, processRemoteInfos, } from '@softarc/native-federation-runtime';\nimport { IMPORT_MAP_FILE_NAME } from '../utils/import-map-loader';\nimport { resolver } from '../utils/loader-as-data-url';\nconst defaultOptions = {\n    remotesOrManifestUrl: {},\n    relBundlePath: '../browser',\n    throwIfRemoteNotFound: false,\n};\nexport async function initNodeFederation(options) {\n    const mergedOptions = { ...defaultOptions, ...options };\n    const importMap = await createNodeImportMap(mergedOptions);\n    // const normalized = resolveAndComposeImportMap(importMap) as ImportMap;\n    // await writeImportMap(normalized);\n    await writeImportMap(importMap);\n    await writeResolver();\n    register(pathToFileURL('./federation-resolver.mjs').href);\n}\nasync function createNodeImportMap(options) {\n    const { remotesOrManifestUrl, relBundlePath } = options;\n    const remotes = typeof remotesOrManifestUrl === 'object'\n        ? remotesOrManifestUrl\n        : await loadFsManifest(remotesOrManifestUrl);\n    const hostInfo = await loadFsFederationInfo(relBundlePath);\n    const hostImportMap = await processHostInfo(hostInfo, './' + relBundlePath);\n    const remotesImportMap = await processRemoteInfos(remotes, {\n        throwIfRemoteNotFound: options.throwIfRemoteNotFound,\n        cacheTag: options.cacheTag,\n    });\n    const importMap = mergeImportMaps(hostImportMap, remotesImportMap);\n    return importMap;\n}\nasync function loadFsManifest(manifestUrl) {\n    const content = await fs.readFile(manifestUrl, 'utf-8');\n    const manifest = JSON.parse(content);\n    return manifest;\n}\nasync function loadFsFederationInfo(relBundlePath) {\n    const manifestPath = path.join(relBundlePath, 'remoteEntry.json');\n    const content = await fs.readFile(manifestPath, 'utf-8');\n    const manifest = JSON.parse(content);\n    return manifest;\n}\nasync function writeImportMap(map) {\n    await fs.writeFile(IMPORT_MAP_FILE_NAME, JSON.stringify(map, null, 2), 'utf-8');\n}\nasync function writeResolver() {\n    const buffer = Buffer.from(resolver, 'base64');\n    await fs.writeFile('federation-resolver.mjs', buffer, 'utf-8');\n}\n","export * from './lib/node/init-node-federation';\n","// server.ts\n\nimport { initNodeFederation } from '@softarc/native-federation-node';\nimport { join } from 'node:path'; // Keep this\n// Remove fileURLToPath and dirname imports (reverting the ESM fix for now)\n\nconsole.log('Starting SSR for Shell');\n\n// üí° NEW LOGIC: Use the absolute path relative to the project root CWD.\n// We are forcing the system to look where the file *must* exist.\n// CWD is /home/tzmijewski/projects/spearhead\nconst BROWSER_DIR_PATH = join(process.cwd(), 'dist', 'spear', 'browser'); \n\n// ... (Your path calculation logic, e.g., BROWSER_DIR_PATH)\n\n(async () => {\n  try { // ‚¨ÖÔ∏è START TRY BLOCK\n    await initNodeFederation({\n      remotesOrManifestUrl: {}, \n      relBundlePath: /*'../browser'*/ BROWSER_DIR_PATH, \n    });\n\n  } catch (e: any) { // ‚¨ÖÔ∏è CATCH THE NON-ERROR VALUE\n    // Log the actual value being thrown for inspection\n    console.error('‚ö†Ô∏è NATIVE FEDERATION ERROR CATCHED:');\n    console.error(e); \n    \n    // Re-throw a standardized Error object to satisfy the Node environment\n    // This allows the Angular CLI to display the log above and then fail gracefully.\n    throw new Error('Native Federation init failed due to non-standard throw value. Check console output above.');\n  } // ‚¨ÖÔ∏è END CATCH BLOCK\n\n  await import('./bootstrap-server');\n\n})();"],"mappings":";;;;;;;;;AAAA,OAAO,UAAU;AACjB,OAAO,SAAS;AAChB,SAAS,YAAY,UAAU;AA0DxB,SAAS,2BAA2B,QAAQ;AAE/C,MAAI,CAAC,cAAc,MAAM,GAAG;AACxB,UAAM,MAAM,kDAAkD;AAAA,EAClE;AAEA,MAAI,6BAA6B,CAAC;AAElC,MAAI,OAAO,eAAe,SAAS,GAAG;AAElC,QAAI,CAAC,cAAc,OAAO,OAAO,GAAG;AAChC,YAAM,MAAM,2DAA2D;AAAA,IAC3E;AAEA,iCAA6B,6BAA6B,OAAO,SAAS,OAAO;AAAA,EACrF;AAEA,MAAI,4BAA4B,CAAC;AAEjC,MAAI,OAAO,eAAe,QAAQ,GAAG;AAEjC,QAAI,CAAC,cAAc,OAAO,MAAM,GAAG;AAC/B,YAAM,MAAM,0DAA0D;AAAA,IAC1E;AAEA,gCAA4B,uBAAuB,OAAO,QAAQ,OAAO;AAAA,EAC7E;AAEA,QAAM,cAAc,OAAO,KAAK,MAAM,EAAE,OAAO,CAAC,QAAQ,QAAQ,aAAa,QAAQ,QAAQ;AAC7F,MAAI,YAAY,SAAS,GAAG;AACxB,YAAQ,KAAK,wBAAwB,YAAY,SAAS,IAAI,MAAM,EAAE,oBAAoB,YAAY,KAAK,IAAI,CAAC,EAAE;AAAA,EACtH;AAEA,SAAO;AAAA,IACH,SAAS;AAAA,IACT,QAAQ;AAAA,EACZ;AACJ;AAEA,SAAS,6BAA6B,KAAKA,UAAS;AAChD,QAAM,aAAa,CAAC;AACpB,WAAS,gBAAgB,KAAK;AAC1B,UAAM,QAAQ,IAAI,YAAY;AAC9B,UAAM,yBAAyB,sBAAsB,cAAcA,QAAO;AAC1E,QAAI,2BAA2B,MAAM;AACjC;AAAA,IACJ;AACA,QAAI,aAAa,sBAAsB,OAAOA,QAAO;AACrD,QAAI,eAAe,MAAM;AACrB,cAAQ,KAAK,iDAAiD,YAAY,GAAG;AAC7E,iBAAW,sBAAsB,IAAI;AACrC;AAAA,IACJ;AACA,QAAI,aAAa,SAAS,GAAG,KAAK,CAAC,WAAW,SAAS,GAAG,GAAG;AACzD,cAAQ,KAAK,iDAAiD,YAAY,4DAA4D;AACtI,iBAAW,sBAAsB,IAAI;AACrC;AAAA,IACJ;AACA,eAAW,sBAAsB,IAAI;AAAA,EACzC;AACA,SAAO;AACX;AAEA,SAAS,sBAAsB,KAAK;AAChC,MAAI,QAAQ,IAAI;AACZ,YAAQ,KAAK,2DAA2D;AACxE,WAAO;AAAA,EACX;AACA,SAAO,sBAAsB,KAAK,OAAO,KAAK;AAClD;AAEA,SAAS,sBAAsB,WAAWA,UAAS;AAC/C,QAAM,qBAAqB,UAAU,WAAW,GAAG,KAC/C,UAAU,WAAW,IAAI,KACzB,UAAU,WAAW,KAAK;AAC9B,MAAI;AACA,WAAO,IAAI,IAAI,WAAW,qBAAqBA,WAAU,MAAS,EAAE;AAAA,EACxE,QACM;AACF,WAAO;AAAA,EACX;AACJ;AAEA,SAAS,uBAAuB,KAAKA,UAAS;AAC1C,MAAI,aAAa,CAAC;AAClB,WAAS,eAAe,KAAK;AACzB,UAAM,wBAAwB,IAAI,WAAW;AAC7C,QAAI,CAAC,cAAc,qBAAqB,GAAG;AACvC,YAAM,UAAU,sBAAsB,WAAW,wBAAwB;AAAA,IAC7E;AACA,QAAI;AACJ,QAAI;AACA,uBAAiB,IAAI,IAAI,aAAaA,QAAO,EAAE;AAAA,IACnD,QACM;AACF,cAAQ,KAAK,qBAAqB,WAAW,mCAAmC;AAChF;AAAA,IACJ;AACA,eAAW,cAAc,IAAI,6BAA6B,uBAAuBA,QAAO;AAAA,EAC5F;AACA,SAAO;AACX;AACA,SAAS,cAAc,KAAK;AACxB,SAAO,QAAQ,OAAO,GAAG,KAAK,CAAC,MAAM,QAAQ,GAAG;AACpD;AA2BA,SAAe,sBAAsB;AAAA;AACjC,UAAM,eAAe,QAAQ,IAAI,mBAAmB;AACpD,UAAM,gBAAgB,KAAK,QAAQ,QAAQ,IAAI,GAAG,YAAY;AAC9D,QAAI;AACJ,QAAI;AACA,YAAM,MAAM,GAAG,SAAS,aAAa;AAAA,IACzC,SACO,KAAK;AACR,aAAO,SAAS;AAAA,IACpB;AACA,QAAI;AACJ,QAAI;AACA,aAAO,MAAM,KAAK,MAAM,GAAG;AAAA,IAC/B,SACO,KAAK;AACR,YAAM,MAAM,iBAAiB,aAAa,2BAA2B,IAAI,OAAO,EAAE;AAAA,IACtF;AACA,WAAO,2BAA2B,IAAI;AAAA,EAC1C;AAAA;AAOA,SAAS,WAAW;AAChB,SAAO,EAAE,SAAS,CAAC,GAAG,QAAQ,CAAC,EAAE;AACrC;AA1NA,IAGa,sBACP,SAkKF;AAtKJ;AAAA;AAGO,IAAM,uBAAuB;AACpC,IAAM,UAAU,IAAI,cAAc,QAAQ,IAAI,CAAC,IAAI,KAAK;AAkKxD,IAAI,mBAAmB,oBAAoB;AA4C3C,WAAO,aAAa,OAAO,cAAc,CAAC;AAC1C,WAAO,WAAW,sBAAsB,SAAS,oBAAoB,SAAS;AAC1E,yBAAmB,QAAQ,KAAK,CAAC,QAAQ;AACrC,eAAO,2BAA2B,GAAG;AAAA,MACzC,CAAC;AAAA,IACL;AAAA;AAAA;;;ACvNA,IAAa;AAAb;AAAA;AAAO,IAAM,WAAW;AAAA;AAAA;;;ACAxB,SAAS,gBAAgB;AACzB,SAAS,qBAAqB;AAC9B,YAAYC,SAAQ;AACpB,YAAYC,WAAU;AACtB,SAAS,iBAAiB,iBAAiB,0BAA2B;AAQtE,SAAsB,mBAAmB,SAAS;AAAA;AAC9C,UAAM,gBAAgB,kCAAK,iBAAmB;AAC9C,UAAM,YAAY,MAAM,oBAAoB,aAAa;AAGzD,UAAM,eAAe,SAAS;AAC9B,UAAM,cAAc;AACpB,aAAS,cAAc,2BAA2B,EAAE,IAAI;AAAA,EAC5D;AAAA;AACA,SAAe,oBAAoB,SAAS;AAAA;AACxC,UAAM,EAAE,sBAAsB,cAAc,IAAI;AAChD,UAAM,UAAU,OAAO,yBAAyB,WAC1C,uBACA,MAAM,eAAe,oBAAoB;AAC/C,UAAM,WAAW,MAAM,qBAAqB,aAAa;AACzD,UAAM,gBAAgB,MAAM,gBAAgB,UAAU,OAAO,aAAa;AAC1E,UAAM,mBAAmB,MAAM,mBAAmB,SAAS;AAAA,MACvD,uBAAuB,QAAQ;AAAA,MAC/B,UAAU,QAAQ;AAAA,IACtB,CAAC;AACD,UAAM,YAAY,gBAAgB,eAAe,gBAAgB;AACjE,WAAO;AAAA,EACX;AAAA;AACA,SAAe,eAAe,aAAa;AAAA;AACvC,UAAM,UAAU,MAAS,aAAS,aAAa,OAAO;AACtD,UAAM,WAAW,KAAK,MAAM,OAAO;AACnC,WAAO;AAAA,EACX;AAAA;AACA,SAAe,qBAAqB,eAAe;AAAA;AAC/C,UAAM,eAAoB,WAAK,eAAe,kBAAkB;AAChE,UAAM,UAAU,MAAS,aAAS,cAAc,OAAO;AACvD,UAAM,WAAW,KAAK,MAAM,OAAO;AACnC,WAAO;AAAA,EACX;AAAA;AACA,SAAe,eAAe,KAAK;AAAA;AAC/B,UAAS,cAAU,sBAAsB,KAAK,UAAU,KAAK,MAAM,CAAC,GAAG,OAAO;AAAA,EAClF;AAAA;AACA,SAAe,gBAAgB;AAAA;AAC3B,UAAM,SAAS,OAAO,KAAK,UAAU,QAAQ;AAC7C,UAAS,cAAU,2BAA2B,QAAQ,OAAO;AAAA,EACjE;AAAA;AApDA,IAOM;AAPN;AAAA;AAKA;AACA;AACA,IAAM,iBAAiB;AAAA,MACnB,sBAAsB,CAAC;AAAA,MACvB,eAAe;AAAA,MACf,uBAAuB;AAAA,IAC3B;AAAA;AAAA;;;ACXA;AAAA;AAAA;AAAA;AAAA;;;ACGA,SAAS,QAAAC,aAAY;AAHrB;;AAEA;AAIA,YAAQ,IAAI,wBAAwB;AAKpC,QAAM,mBAAmBA,MAAK,QAAQ,IAAG,GAAI,QAAQ,SAAS,SAAS;AAIvE,KAAC,MAAW;AACV,UAAI;AACF,cAAM,mBAAmB;UACvB,sBAAsB,CAAA;UACtB;;YAAgC;;SACjC;MAEH,SAAS,GAAQ;AAEf,gBAAQ,MAAM,+CAAqC;AACnD,gBAAQ,MAAM,CAAC;AAIf,cAAM,IAAI,MAAM,4FAA4F;MAC9G;AAEA,YAAM,OAAO,sBAAoB;IAEnC,IAAE;;;","names":["baseURL","fs","path","join"],"x_google_ignoreList":[0,1,2,3]}