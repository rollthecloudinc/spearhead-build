import { a as z } from "@nf-internal/chunk-SY4IZ54E";
import "@nf-internal/chunk-7QKABEPV";
import "@nf-internal/chunk-XE5S2H6D";
import { a as p, b as w, h as k } from "@nf-internal/chunk-GL2BOVXA";
var P = k(z(), 1);
import * as f from "@angular/core";
import { PLATFORM_ID as I } from "@angular/core";
import * as O from "@rollthecloudinc/auth";
import { AuthModule as A } from "@rollthecloudinc/auth";
import "@rollthecloudinc/awcog";
import { COGNITO_SETTINGS as E } from "@rollthecloudinc/awcog";
import * as v from "@rollthecloudinc/crud";
import { CrudAdaptorPlugin as T, CrudModule as N } from "@rollthecloudinc/crud";
import { of as c, forkJoin as M, from as S, firstValueFrom as b } from "rxjs";
import { SignatureV4 as x } from "@aws-sdk/signature-v4";
import { HttpRequest as F } from "@aws-sdk/protocol-http";
import { fromCognitoIdentityPool as q } from "@aws-sdk/credential-provider-cognito-identity";
import { CognitoIdentityClient as J } from "@aws-sdk/client-cognito-identity";
import { switchMap as m, map as i, tap as g, catchError as D, take as G } from "rxjs/operators";
import * as j from "@rollthecloudinc/dparam";
import * as _ from "@angular/common/http";
var R = (l, $, h, u, s) => new T({ id: "aws_opensearch_template", title: "AWS Opensearch Template", create: ({ object: o, identity: r, params: a, parentObject: e }) => c({ success: !1 }), read: ({}) => c({ success: !1 }), update: ({ object: o, identity: r, params: a, parentObject: e }) => c({ success: !1 }), delete: ({}) => c({ success: !1 }), query: ({ rule: o, params: r }) => c({ entities: [], success: !1 }).pipe(m(() => r && Object.keys(r).length !== 0 ? M(Object.keys(r).map(a => u.paramValue(r[a], new Map).pipe(i(e => ({ [a]: e }))))).pipe(i(a => a.reduce((e, t) => p(p({}, e), t), {})), i(a => ({ options: a }))) : c({ options: {} })), i(({ options: a }) => ({ options: a, body: JSON.stringify({ id: a.id, params: o ? o.conditions.all.reduce((e, t) => p(p({}, e), t.any.reduce((n, d) => w(p({}, n), { [d.path.substr(2)]: [...n[d.path.substr(2)] ? n[d.path.substr(2)] : [], JSON.parse(decodeURIComponent(d.value))] }), {})), {}) : {} }) })), g(({ body: a }) => console.log("open search template query body", a)), m(({ options: a, body: e }) => C({ method: "POST", body: e, headers: { "Content-Type": "application/json", host: `${a.domain}.${a.region}.es.amazonaws.com` }, hostname: `${a.domain}.${a.region}.es.amazonaws.com`, path: `/${a.index}/_search/template`, protocol: "https:", service: "es", cognitoSettings: h, authFacade: $ }).pipe(i(t => ({ signedHttpRequest: t, options: a })))), m(({ signedHttpRequest: a, options: e }) => { delete a.headers.host; let t = `https://${e.domain}.${e.region}.es.amazonaws.com/${e.index}/_search/template`; return s.post(t, a.body, { headers: a.headers, withCredentials: !1 }).pipe(i(n => ({ res: n, options: e }))); }), i(({ res: a, options: e }) => ({ entities: e.hits && a && a.hits && a.hits.hits ? a.hits.hits.map(t => e.source ? t._source : t) : [a], success: !0 }))) }), U = (l, $, h, u) => new T({ id: "aws_opensearch_entity", title: "AWS Opensearch Entity", create: ({ object: s, identity: o, params: r, parentObject: a }) => c({ success: !1 }).pipe(h.resolveParams({ params: r }), m(({ options: e }) => o({ object: s, parentObject: a }).pipe(i(({ identity: t }) => ({ identity: t, options: e })))), m(({ options: e, identity: t }) => C(w(p({ method: "PUT", body: JSON.stringify(s), headers: { "Content-Type": "application/json", host: `${e.domain}.${e.region}.es.amazonaws.com` }, hostname: `${e.domain}.${e.region}.es.amazonaws.com`, path: `/${e.index}/_doc/${t}`, protocol: "https:", service: "es" }, p({}, e.pipeline ? { query: { pipeline: e.pipeline } } : {})), { cognitoSettings: $, authFacade: l })).pipe(i(n => ({ signedHttpRequest: n, options: e, identity: t })))), m(({ signedHttpRequest: e, options: t, identity: n }) => { delete e.headers.host; let d = `https://${t.domain}.${t.region}.es.amazonaws.com/${t.index}/_doc/${n}`; return u.put(d, JSON.stringify(s), { headers: e.headers, withCredentials: !1, params: p({}, t.pipeline ? { pipeline: t.pipeline } : {}) }).pipe(i(y => ({ res: y, options: t }))); }), i(() => ({ success: !0 }))), read: ({}) => c({ success: !1 }), update: ({ object: s, identity: o, params: r, parentObject: a }) => c({ success: !1 }).pipe(h.resolveParams({ params: r }), m(({ options: e }) => o({ object: s, parentObject: a }).pipe(i(({ identity: t }) => ({ identity: t, options: e })))), m(({ options: e, identity: t }) => C(w(p({ method: "PUT", body: JSON.stringify(s), headers: { "Content-Type": "application/json", host: `${e.domain}.${e.region}.es.amazonaws.com` }, hostname: `${e.domain}.${e.region}.es.amazonaws.com`, path: `/${e.index}/_doc/${t}`, protocol: "https:", service: "es" }, p({}, e.pipeline ? { query: { pipeline: e.pipeline } } : {})), { cognitoSettings: $, authFacade: l })).pipe(i(n => ({ signedHttpRequest: n, options: e, identity: t })))), m(({ signedHttpRequest: e, options: t, identity: n }) => { delete e.headers.host; let d = `https://${t.domain}.${t.region}.es.amazonaws.com/${t.index}/_doc/${n}`; return u.put(d, JSON.stringify(s), { headers: e.headers, withCredentials: !1, params: p({}, t.pipeline ? { pipeline: t.pipeline } : {}) }).pipe(i(y => ({ res: y, options: t }))); }), i(() => ({ success: !0 }))), delete: ({}) => c({ success: !1 }), query: ({ rule: s, params: o }) => c({ entities: [], success: !1 }).pipe(g(() => { console.log("crud open search query", s, o); }), h.resolveParams({ params: o }), i(({ options: r }) => ({ options: r, identityCondition: s.conditions.all.map(a => a.any.find(e => e.fact === "identity")).find(a => !!a) })), m(({ options: r, identityCondition: a }) => C({ method: "GET", headers: { "Content-Type": "application/json", host: `${r.domain}.${r.region}.es.amazonaws.com` }, hostname: `${r.domain}.${r.region}.es.amazonaws.com`, path: `/${r.index}/_doc/${a ? a.value : ""}`, protocol: "https:", service: "es", cognitoSettings: $, authFacade: l }).pipe(g(() => console.log(".marker({ event: AFTER , entity: opensearch , op: query , meta: { action: createSignedRequest } })")), g(e => delete e.headers.host), i(e => ({ signedHttpRequest: e, options: r, url: `https://${r.domain}.${r.region}.es.amazonaws.com${e.path}` })), g(() => console.log(".marker({ event: BEFORE , entity: crud , op: query , meta: { http: get } })")), m(({ signedHttpRequest: e, url: t }) => u.get(t, { headers: e.headers, withCredentials: !1 }).pipe(D(() => c(void 0)))), g(() => console.log(".marker({ event: AFTER , entity: opensearch , op: query , meta: { http: get } })")), i(e => ({ entities: e ? [e._source] : [], success: !!e }))))) }), C = ({ body: l, headers: $, hostname: h, method: u = "GET", path: s = "/", port: o = 443, protocol: r = "https:", query: a, service: e, cognitoSettings: t, authFacade: n }) => c(new F({ body: l, headers: $, hostname: h, method: u, path: s, port: o, protocol: r, query: a })).pipe(g(() => console.log(".marker({ event: BEGIN , context: os, entity: sig , op: signv4 , meta: {  } })")), m(d => S(new x({ credentials: q({ client: new J({ region: t.region }), identityPoolId: t.identityPoolId, logins: { [`cognito-idp.${t.region}.amazonaws.com/${t.userPoolId}`]: () => b(n.getUser$.pipe(i(y => y ? y.id_token : void 0))) } }), region: t.region, service: e, sha256: P.Sha256, applyChecksum: !1 }).sign(d).then(y => (console.log(".marker({ event: RESOLVED, entity: os , op: signv4 , meta: {  } })"), y))).pipe(g(() => console.log(".marker({ /os/sign/after/sig })")), G(1))), i(d => d), g(() => console.log(".marker({ event: END , context: os, entity: sig , op: signv4 , meta: {  } })"))), re = (() => { class l {
    constructor(h, u, s, o, r, a) { s.register(R(u, o, h, r, a)), s.register(U(o, h, r, a)); }
    static { this.\u0275fac = function (u) { return new (u || l)(f.\u0275\u0275inject(E), f.\u0275\u0275inject(I), f.\u0275\u0275inject(v.CrudAdaptorPluginManager), f.\u0275\u0275inject(O.AuthFacade), f.\u0275\u0275inject(j.ParamEvaluatorService), f.\u0275\u0275inject(_.HttpClient)); }; }
    static { this.\u0275mod = f.\u0275\u0275defineNgModule({ type: l }); }
    static { this.\u0275inj = f.\u0275\u0275defineInjector({ imports: [A, N] }); }
} return l; })();
export { re as AwosModule };
//# sourceMappingURL=_rollthecloudinc_awos.unONHLVK3f.js.map
