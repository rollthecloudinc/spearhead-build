{
  "version": 3,
  "sources": ["../../@rollthecloudinc/keyval/fesm2022/rollthecloudinc-keyval.mjs"],
  "sourcesContent": ["import * as i0 from '@angular/core';\nimport { NgModule } from '@angular/core';\nimport * as i1 from '@rollthecloudinc/crud';\nimport { CrudAdaptorPlugin, CrudModule } from '@rollthecloudinc/crud';\nimport { Observable, of, forkJoin } from 'rxjs';\nimport { switchMap, map, concatMap, filter, reduce, defaultIfEmpty } from 'rxjs/operators';\nimport { keys, getMany, set, setMany } from 'idb-keyval';\nimport * as jre from 'json-rules-engine';\nimport * as jpp from 'jsonpath-plus';\nimport { isPlatformBrowser } from '@angular/common';\nimport * as i2 from '@rollthecloudinc/dparam';\nconst idbEntityCrudAdaptorPluginFactory = paramsEvaluatorService => {\n  return new CrudAdaptorPlugin({\n    id: 'idb_keyval',\n    title: 'Idb Keyval',\n    create: ({\n      object,\n      identity,\n      params,\n      parentObject\n    }) => of({\n      success: false\n    }).pipe(switchMap(() => identity({\n      object,\n      parentObject\n    }).pipe(map(({\n      identity\n    }) => ({\n      identity\n    })))), switchMap(({\n      identity\n    }) => params && Object.keys(params).length !== 0 ? forkJoin(Object.keys(params).map(name => paramsEvaluatorService.paramValue(params[name], new Map()).pipe(map(v => ({\n      [name]: v\n    }))))).pipe(map(groups => groups.reduce((p, c) => ({\n      ...p,\n      ...c\n    }), {})),\n    // default options go here instead of empty object.\n    map(options => ({\n      identity,\n      options\n    }))) : of({\n      identity,\n      options: {}\n    })), map(({\n      identity,\n      options\n    }) => ({\n      name: options.prefix + identity\n    })), switchMap(({\n      name\n    }) => new Observable(obs => {\n      set(name, object).then(res => {\n        console.log('idb write suceeded');\n        console.log(res);\n        obs.next({\n          success: true\n        });\n        obs.complete();\n      }).catch(e => {\n        console.log('idb write failed');\n        console.log(e);\n        obs.next({\n          success: false\n        });\n        obs.complete();\n      });\n    }))),\n    read: ({}) => of({\n      success: false\n    }),\n    update: ({\n      object,\n      identity,\n      params,\n      parentObject\n    }) => of({\n      success: false\n    }).pipe(switchMap(() => identity({\n      object,\n      parentObject\n    }).pipe(map(({\n      identity\n    }) => ({\n      identity\n    })))), switchMap(({\n      identity\n    }) => params && Object.keys(params).length !== 0 ? forkJoin(Object.keys(params).map(name => paramsEvaluatorService.paramValue(params[name], new Map()).pipe(map(v => ({\n      [name]: v\n    }))))).pipe(map(groups => groups.reduce((p, c) => ({\n      ...p,\n      ...c\n    }), {})),\n    // default options go here instead of empty object.\n    map(options => ({\n      identity,\n      options\n    }))) : of({\n      identity,\n      options: {}\n    })), map(({\n      identity,\n      options\n    }) => ({\n      name: options.prefix + identity\n    })), switchMap(({\n      name\n    }) => new Observable(obs => {\n      set(name, object).then(res => {\n        console.log('idb write suceeded');\n        console.log(res);\n        obs.next({\n          success: true\n        });\n        obs.complete();\n      }).catch(e => {\n        console.log('idb write failed');\n        console.log(e);\n        obs.next({\n          success: false\n        });\n        obs.complete();\n      });\n    }))),\n    delete: ({}) => of({\n      success: false\n    }),\n    // query: ({}: CrudCollectionOperationInput) => of<CrudCollectionOperationResponse>({ success: false, entities: [] })\n    query: ({\n      params,\n      rule,\n      identity\n    }) => paramsEvaluatorService.paramValues(new Map(Object.keys(params).map(name => [name, params[name]]))).pipe(switchMap(options => new Observable(obs => {\n      keys().then(keys => keys.filter(k => `${k}`.indexOf(options.get('prefix')) === 0)).then(keys => getMany(keys)).then(entities => {\n        obs.next({\n          entities,\n          success: true\n        });\n        obs.complete();\n      });\n    })), switchMap(out => !rule ? of(out) : new Observable(obs => {\n      const engine = new jre.Engine();\n      // This should not be here should be setup for default engine but for now whatever.\n      engine.addOperator('startsWith', (fv, jv) => typeof jv === 'string' && typeof fv === 'string' && jv.indexOf(fv) === 0);\n      engine.addOperator('term||wildcard', (fv, jv) => {\n        const jsonValue = JSON.parse(decodeURIComponent(jv));\n        const terms = jpp.JSONPath({\n          path: `$.term.*.value.@string()`,\n          json: jsonValue,\n          flatten: true\n        });\n        return jsonValue.wildcard !== undefined || jsonValue.term && terms.lengh !== 0 && terms[0] === fv;\n      });\n      engine.addRule(rule);\n      engine.addFact('identity', (_, almanac) => new Observable(obs2 => {\n        almanac.factValue('entity').then(object => identity({\n          object\n        }).pipe(map(({\n          identity\n        }) => identity)).toPromise()).then(id => {\n          obs2.next(id);\n          obs2.complete();\n        });\n      }).toPromise(), {\n        cache: false\n      });\n      of(...out.entities).pipe(concatMap(entity => new Observable(obs2 => {\n        engine.removeFact('entity');\n        engine.addFact('entity', entity, {\n          cache: false\n        });\n        engine.run().then(res => {\n          obs2.next([entity, res.events.findIndex(e => e.type === 'visible') > -1]);\n          obs2.complete();\n        });\n      })), filter(([_, matched]) => matched), map(([entity]) => entity), reduce((acc, v) => [...acc, v], []), defaultIfEmpty([])).subscribe(entities => {\n        obs.next({\n          ...out,\n          entities\n        });\n        obs.complete();\n      });\n    })))\n  });\n};\nconst initializeIdbDataFactory = ({\n  data,\n  key\n}) => platformId => {\n  return () => new Observable(obs => {\n    if (isPlatformBrowser(platformId)) {\n      const items = data.map(d => [key({\n        data: d\n      }), d]);\n      setMany(items).then(() => {\n        console.log('data loaded into idb');\n        obs.next();\n        obs.complete();\n      }).catch(() => {\n        console.log('data load into idb failure');\n        obs.next();\n        obs.complete();\n      });\n    } else {\n      obs.next();\n      obs.complete();\n    }\n  });\n};\nlet KeyvalModule = /*#__PURE__*/(() => {\n  class KeyvalModule {\n    constructor(cpm, paramsEvaluatorService) {\n      cpm.register(idbEntityCrudAdaptorPluginFactory(paramsEvaluatorService));\n    }\n    static {\n      this.\u0275fac = function KeyvalModule_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || KeyvalModule)(i0.\u0275\u0275inject(i1.CrudAdaptorPluginManager), i0.\u0275\u0275inject(i2.ParamEvaluatorService));\n      };\n    }\n    static {\n      this.\u0275mod = /* @__PURE__ */i0.\u0275\u0275defineNgModule({\n        type: KeyvalModule\n      });\n    }\n    static {\n      this.\u0275inj = /* @__PURE__ */i0.\u0275\u0275defineInjector({\n        imports: [CrudModule]\n      });\n    }\n  }\n  return KeyvalModule;\n})();\n(() => {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && void 0;\n})();\n\n/*\n * Public API Surface of keyval\n */\n\n/**\n * Generated bundle index. Do not edit.\n */\n\nexport { KeyvalModule, idbEntityCrudAdaptorPluginFactory, initializeIdbDataFactory };\n"],
  "mappings": "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",
  "names": ["jre", "jpp", "i0", "i1", "CrudAdaptorPlugin", "CrudModule", "Observable", "of", "forkJoin", "switchMap", "map", "concatMap", "filter", "reduce", "defaultIfEmpty", "keys", "getMany", "set", "setMany", "isPlatformBrowser", "i2", "idbEntityCrudAdaptorPluginFactory", "paramsEvaluatorService", "CrudAdaptorPlugin", "object", "identity", "params", "parentObject", "of", "switchMap", "map", "forkJoin", "name", "v", "groups", "p", "c", "__spreadValues", "options", "Observable", "obs", "set", "res", "e", "rule", "keys", "k", "getMany", "entities", "out", "engine", "fv", "jv", "jsonValue", "terms", "_", "almanac", "obs2", "id", "concatMap", "entity", "filter", "matched", "reduce", "acc", "defaultIfEmpty", "__spreadProps", "initializeIdbDataFactory", "data", "key", "platformId", "isPlatformBrowser", "items", "d", "setMany", "KeyvalModule", "cpm", "__ngFactoryType__", "CrudModule"]
}
